---
title: "Late Pleistocene stone artefact technology at Mau A, Yen Bai, Norther Vietnam"
author:
  - Quinn Habedank:
      email: fl@oneoeurhg.edu
      institute: [UofO]
      correspondence: true
  - Ben Marwick:
      email: fl@another.edu
      institute: [UofA]
      correspondence: false
institute:
  - UofO: University of One Place
  - UofA: University of Another Place
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->

Keywords: `r rmarkdown::metadata$keywords`

Highlights: `r rmarkdown::metadata$highlights`

<!-- The following code chunk defines some general settings how code chunks should behave. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 300
)
```

<!-- The actual document text starts here: -->

# Abstract

Flaked stone artefacts from Southeast Asia typically lack visually distinctive and strongly patterned forms, which can make them challenging to analyze and interpret. As a result, many of the cultural dynamics of Pleistocene hunter-gatherers of this region are poorly understood. We use 2D shape data to hypothesize a relationship between unretouched flake shape and assemblage reduction intensity at Mau A, an early Holocene archaeological site in northern Vietnam. We apply a Principal Components Analysis to the flake outlines to investigate shape variation throughout the reduction sequence (measured by dorsal cortex coverage). We find that flake shape varies by reduction stage, primarily through differences in flake length and width. Our results suggest that flake shape is sensitive to assemblage reduction intensity, and may give useful comparative insights when other attributes show little variation. These results are important for understanding stone artefact assemblages from Southeast Asia which often yield little variation when analysed with traditional approaches.

## Introduction

- Stone tools from South East Asia tend to lack distinctive typological categories (Mijares 2008; Borel et al. 2013; Borel et al. 2017)
- The purpose of this study was to examine the relationship between flake shape and reduction intensity
- Approach used in the paper is a response to the lack of traditional typological categories in South East Asia

Here is a citation [@Marwick2017]

<!-- BM: In this section we need to review previous work on investigating flake shape and identifying what affects flake shape, not just in Southeast Asia, but anywhere in the world -->

## Excavations at Mau A

Mau A is an open air archaeological site located on the banks above 5 m above the Red River in Yen Bai Province, Northern Vietnam, at the confluence of a small stream entering the river. Excavations were conducted in 2015 by a collaboration including researchers from the University of Washington, the Yen Bai Provincial Museum, the Institute of Archaeology in Hanoi, and the Vietnam National University - Social Sciences and Humanities University. An area of 2 x 2 m was excavated in 13 units of ten centimeters deep, through dense silty clay deposits to a depth of about 1.3 m below the surface. Subtle changes in stratigraphy indicated a slightly sloping deposit with four layers, consistent with reports of excavations in this location in the 1980s. A small amount of plastic and modern ceramics were found in the uppermost 0.1 m of deposit. The most striking feature identified during our excavations was the third layer, which is distinctive as very dense layer of flaked stone artefacts at about 0.6-1.1 m below the surface. No other features were identified during excavation.

This dense lithic layer contained the majority of stone artefacts recovered from the site. The  chaîne opératoire of Mau A lithic technology is composed of unifacial shaping on long cobbles to produce sumatraloids (sumatralith-like pieces). The chaîne opératoire also involved the shaping of thick ovoid cobbles for the production of choppers or chopping-tools and half-cobbles (longitudinally split) that are shaped into tools with transverse cutting edges. Flake scar surfaces and edges are fresh and unweathered, indicating _in situ_ production and limited post-depositional movement. While previous work has claimed the Mau A assemblage is Son Vian (a precurser to Hoabinhian technology, characterised by unifacial flaking of blocky, cubic cobbles)

<!-- BM: need to cite The Oxford Handbook of the Archaeology and Anthropology of Hunter-Gatherers, Ha Van Tan 1997, and the Proceedings of the Prehistoric Society -->

Four radiocarbon ages were obtained from isolated charcoal fragments in the deposit. The charcoal was sampled to bracket the upper and lower boundaries of the dense lithic layer. <!-- add calibrated age numbers here --> The ages indicate a rapid accumulation process for this layer at the terminal Pleistocene. 

<!-- BM: add a paragraph on MH's pollen analysis to indicate local palaeoenvironment, and add her as co-author-->


## Methods

  Dorsal cortex percentages discretized upon standard cut points were used to create reduction categories. Flakes with no dorsal cortex were categorized as tertiary flakes, those with up to a dorsal cortex percentage of 50% were considered secondary and those with a dorsal cortex value greater than 50% were considered primary (Bradbury & Carr 1995). Mass clusters were generated using univariate k-means, with the end result being 6 mass clusters, with mass cluster 1 having the least mass on average and 6 having the greatest mass on average. 
  
  Univariate k-means is a non-hierarchical clustering technique that creates a set number of groups equal to k, with points being assigned to groups in such a manner that the total distances between each point and mean of the group in minimized. We used the Ckmeans.1d.dp package in R to perform our univariate k-means analysis (Wang & Song, 2011). The Ckmeans.1d.dp has been used for univariate clustering in applications outside of archaeology prior to our work (Song & Zhong, 2020).

  We initially recorded conventional linear dimension measurements, such as max dimension length and width at various points along the max dimension length, from all flakes recovered from the excavation. Then we converted these linear dimensions into landmarks points to represent the size and shape of each artefact. The specific linear measurements used to create the 2D landmarks were the top horizontal measurement, the max dimension length, width at a quarter of the maximum length, width at half of the maximum length, and width at three quarters of the maximum length.

<!-- BM: Because our approach here is very novel, most readers will struggle to understand it. To help them, I think we will need a table that defines each of our dimensions, and a figure that shows an example of our landmark points on a typical artefact -->

  The outlines formed by the shape landmarks were then normalized for size, orientation, and rotation. We used Generalized Procrustes Analysis to strip the flakes in the sample dataset of size, orientation, and rotation, leaving only shape data. Generalized Procrustes Analysis (or GPA) is a statistical tool for taking shapes on a 2D plane and normalizing them so as to only examine the absolute shape of a set of landmarks. For an example of GPA being utilized to examine 2D landmarks in an archaeological context, refer to Jung & Woo (2019).

  Finally, the shape landmark values were analysed by Principal Components Analysis, a form of exploratory data analysis. Our method for carrying out the PCA on the shape landmarks was inspired by Theska et al. (2020), which also performed 2D landmark data analysis using PCA. Principal Component Analysis takes the initial set of data and transforms the initial set of variables into a smaller set of variables whist still preserving most of the variation seen in the initial data set. PCA biplots, which plot out the first two primary components, were created to visualize differences based upon secondary categorical variables, namely flake reduction categories, excavation unit, and mass cluster. The first two primary components formulated the individual points on biplot, while the secondary variables (flake reduction categories, excavation unit, and mass clusters) were represented by colored outlines on the biplots

<!-- BM: Need to add citations to give the reader further information on GPA and shape analysis in archaeology. Need to add a sentence of definitino of what is GPA and what is PCA. Partly to guide the reader to more details, if they want it, and partly to demonstrate our expertise with the method -->

<!-- QH: Added more information on GPA and PCA, as well as an addition citation -->

  
<!-- BM: Need to add citations and definition about univariate k-means -->

<!-- QH: added more info on univariate k-means, as well as a citation  -->

## Results

<!-- BM: basic stats on raw materials and change in technology by depth to satisfy readers about the basic details of the assemblage, 

<!-- BM: then QH's more complex analysis on flakes after the basic data -->

<!-- BM: then previous more complex analysis on cores after QH's analysis of flakes -->



## PCA Analysis on Dorsal Cortex Groups

```{r}
library(tidyverse)

# import the data
ma_flakes <- readxl::read_excel(here::here("analysis/data/raw_data/UW Fieldschool Mau A 2015 post_excavation_season_April_2016.xlsx"),
                                col_names = FALSE)

# transpose so that columns are variables, rows are individual artefacts
# and set col data types so we can compute on them
ma_flakes_tr <-
ma_flakes %>%
  pivot_longer(-`...1`)  %>%
  pivot_wider(names_from = `...1`,
              values_from = value) %>%
  mutate_all(parse_guess) %>%
  # fix a few bad guesses
  mutate(across(c(mass,
                thickness_at_0.25_width,
                thickness_at_0.75_width,
                dorsal_cortex_perc,
                dorsal_scar_initiation_count),
         parse_number))

# export this data frame to use with our analysis
write_csv(ma_flakes_tr,
          here::here("analysis/data/derived_data/ma_flakes_tr.csv"))

```

```{r}
# here we import the CSV file of caliper measurements, then compute on the
# measurements to generate coordinates for a shape outline

library(tidyverse)

# import the data 
ma_flakes_tr <- read_csv(here::here("analysis/data/derived_data/ma_flakes_tr.csv"))


# custom function is from here, we have a local version in 999-functions.R
# so we can work offline if we need to
# https://gist.github.com/benmarwick/fac5754131c1fcc14d32b1658215f0e3

source(here::here("analysis/code/999-functions.R"))

polys <- polygon_shape_by_variables(data = ma_flakes_tr,       # our data frame
                                    x = 'width_at_0.50_length',                # col for coord for x-axis of poly centers
                                    y = 'max_dimension',       # col for coord for y-axis of poly centers

                                    sf = 10,    # scale factor
                                    top_horizontal_measurement =    'platform_width', # cols to use to compute poly verts
                                    main_vertical_measurement =     'percussion_length',
                                    upper_horizontal_measurement =  'width_at_0.25_length',
                                    middle_horizontal_measurement = 'width_at_0.50_length',
                                    bottom_horizontal_measurement = 'width_at_0.75_length')


# make ready to convert to TPS format (thin plate spline)
polys_lmk <-
polys %>%
  group_by(fill) %>%
  mutate(landmark.number = row_number(fill),
         specimen.ids  = fill) %>%
  ungroup() %>%
  select(-fill)

# export as TPS file
create_tps(polys_lmk,
           here::here("analysis/data/derived_data/landmarks.tps"))

```


```{r}

library(tidyverse)
library(geomorph)
library(Morpho)
library(mclust)
library(cluster)
library(factoextra)

lands <- readland.tps(
  here::here("analysis/data/derived_data/landmarks.tps"),
  specID = "ID")

# drop outliers  identified in the previous script
outlier_ids <- c(1152,  606, 1147, 1125,  756 ,1023,  457,
                 813,  415,  877,  677, 1055,  239,  811,  601,  861,
                  794,  103 , 598 ,1110 , 906 ,  59 ,   4)

lands_no_outliers <- lands[, , -outlier_ids]
lands_no_outliers_names <- dimnames(lands_no_outliers)[[3]]

sup.geo <- gpagen(lands_no_outliers,  ProcD=F, Proj = T)

# Principal component analysis (PCA) using a base R function
pca.geo <- prcomp(two.d.array(sup.geo$coord))

# TODO: find a meaningful way to break this up into groups
# pass these groups onto the PCA for drawing ellipses

# this block of code below shows one way to discretize cortex percentage
# into three groups. We need to explore other cutoffs, and other grouping
# variables besides dorsal cortex. This code below is a good template for
# starting these explorations
```

```{r cortex-biplot}
# Note, trying to fix NA by removing all rows which lack dorsal cortex values. Issue with the initial set of data with NA values being passed through PCA. In the process of fixing

# Adding extra groups needed for biplots, as well as removing the outliers brought up earlier

ma_flakes_tr_with_groups <-
  ma_flakes_tr %>%
  slice(-c(1152,  606, 1147, 1125,  756 ,1023,  457,
                 813,  415,  877,  677, 1055,  239,  811,  601,  861,
                  794,  103 , 598 ,1110 , 906 ,  59 ,   4)) %>% 
 # filter(!is.na(dorsal_cortex_perc)) %>% 
  mutate(dorsal_cortext_group =
           case_when(
             between(dorsal_cortex_perc, 0, 0) ~ "Tertiary",
             between(dorsal_cortex_perc, 1, 50) ~ "Secondary",
             between(dorsal_cortex_perc, 51, 100) ~ "Primary"
           ))

library(Ckmeans.1d.dp)

test_result_mass <- Ckmeans.1d.dp(ma_flakes_tr_with_groups$mass)

ma_flakes_tr_with_groups <-
  ma_flakes_tr_with_groups %>% 
  mutate(mass_group = as.factor(test_result_mass$cluster))

# ggplot2-based plot of the PCA results using a factoextra function
fviz_pca_ind(pca.geo,
             geom.ind = "point", # show points without labels
            #  line below sets the grouping column for colouring the points
             habillage = ma_flakes_tr_with_groups$dorsal_cortext_group,
             palette = "npg", #color palette, adjust to preferences
             addEllipses = T, #adds ellipses or convex hulls
             ellipse.type = "convex", #convex hulls
             mean.point = F, #don’t show average point
             legend.title = "Dorsal Cortex Class") +  #adjust accordingly)
             coord_fixed(ratio = 1)+ #adjustable for variation-weighted plots
  theme(plot.title = element_blank())







```

<!-- QH: Later on, the language "the visualization above" will be changed to "Figure X." -->
<!-- QH: Also, on a secondary note, I had to copy the data file into a different location. That means that there are redundant data files that will need to be cleaned up later -->

<!--“biplot above” replace this figure \@ref(fig:code-block-name)  code-block-name is like this ```{r code-block-name} be sure to give them descriptive, simple names -->

  Figure \@ref(fig:cortex-biplot) shows flake shape (as defined within the first two principal components) in relation to dorsal cortex class. The primary class of dorsal cortex, representing initial, unretouched flakes in the reduction sequence, has the smallest range of shape variation. Secondary flakes, which have been retouched and thus have less dorsal cortex than the primary flakes, show a slighly larger range of shape variation. Lastly, the tertiary flakes at the end of the reduction sequence show the greatest amount of shape variation. 

  Shape variation is not equal along both principal components. For flakes in all three dorsal cortex classes, the largest differences between each inter-nested is along the first principal component. Slight differences are seen along the second principal component, with an increasing amount of variation as one goes from primary to secondary to tertiary flakes, but these changes are minor when compared to the larger changes seen in the first principal component. 
  
```{r}
# Excavation unit PCA
# ggplot2-based plot of the PCA results using a factoextra function
fviz_pca_ind(pca.geo,
             geom.ind = "point", # show points without labels
            #  line below sets the grouping column for colouring the points
             habillage = as.factor(ma_flakes_tr_with_groups$Unit),
             palette = viridis::cividis(13), # color palette, adjust to preferences
             addEllipses = T, #adds ellipses or convex hulls
             ellipse.type = "convex", #convex hulls
             mean.point = F, #don’t show average point
             legend.title = "Excavation\nunit",
             title = "Change over time in flake shape") +  #adjust accordingly)
             coord_fixed(ratio = 1)  + #adjustable for variation-weighted plots
             theme(panel.background = element_rect(fill='white',
                                        colour = "white"),
              plot.background = element_rect(fill='white',
                                       colour = "white")) 
```


<!-- Need to add in code that actually creates the mass groups -->

```{r}




# Mass PCA
# ggplot2-based plot of the PCA results using a factoextra function
fviz_pca_ind(pca.geo,
             geom.ind = "point", # show points without labels
            #  line below sets the grouping column for colouring the points
             habillage = ma_flakes_tr_with_groups$mass_group,
             palette = viridis::viridis(6), #color palette, adjust to preferences
             addEllipses = T, #adds ellipses or convex hulls
             ellipse.type = "convex", #convex hulls
             mean.point = F, #don’t show average point
             legend.title = "Mass\ncluster",  #adjust accordingly
            title = "Flake mass and flake shape") + 
             coord_fixed(ratio = 1) + #adjustable for variation-weighted plots
             theme(panel.background = element_rect(fill='white',
                                        colour = "white"),
              plot.background = element_rect(fill='white',
                                       colour = "white")) 







```




<!-- QH: This code chunk below I copied from the old repo. The visualizations on dimension contributions are relevant to my second paragraph. I need to go back to some of my old work to see which values pertain to which measurement on the flakes, and to write up a paragraph or two elaborating on what I have already said. -->

```{r}
# let's look at all the PCs and how much each original # variable contributes to them

#view how much variation is described by each PC (ordered from PC1 to last PC)
# enframe(100*pca.geo$sdev^2/sum(pca.geo$sdev^2))

#get meaningful PCs
# getMeaningfulPCs(pca.geo$sdev^2, n = length(lands_no_outliers_names))

#estimate contribution (%) of landmarks on PC1
PC1_contrib <- fviz_contrib(pca.geo, choice = "var", axes = 1)
# take a look at the plot
# PC1_contrib

LM_contrib_PC1 <- data.frame(LM = rep(NA, nrow(PC1_contrib$data)/2),
                             PC1_contrib = rep(NA, nrow(PC1_contrib$data)/2))
for (i in 1:(nrow(PC1_contrib$data)/2)) {
  LM_contrib_PC1$PC1_contrib[i] <- sum(PC1_contrib$data[(i*2-1):(i*2),]$contrib)
  LM_contrib_PC1$LM[i] <- as.character(i)
}

# TODO: decode the x-axis labels on the scree plot so we can describe in
# terms of actual flake dimension, write some sentences to describe and interpret

# estimate contribution (%) of landmarks on PC2
PC2_contrib <- fviz_contrib(pca.geo, choice = "var", axes = 2)
# take a look at the plot
# PC2_contrib

LM_contrib_PC2 <- data.frame(LM = rep(NA, nrow(PC2_contrib$data)/2),
                             PC2_contrib = rep(NA, nrow(PC2_contrib$data)/2))
for (i in 1:(nrow(PC2_contrib$data)/2)) {
  LM_contrib_PC2$PC2_contrib[i] <- sum(PC2_contrib$data[(i*2-1):(i*2),]$contrib)
  LM_contrib_PC2$LM[i] <- as.character(i)
}

# examine landmarks with major contribution (%) to PC1 and PC2
# important_LMs_PC1 <- LM_contrib_PC1[LM_contrib_PC1$PC1_contrib > 100/(nrow(PC1_contrib$data)/2),]
# important_LMs_PC1[order(decreasing = T, important_LMs_PC1$PC1_contrib),]
# important_LMs_PC2 <- LM_contrib_PC2[LM_contrib_PC2$PC2_contrib > 100/(nrow(PC2_contrib$data)/2),]
# here is a table that summarises the most important landmarks in the PCA
# important_LMs_PC2[order(decreasing = T, important_LMs_PC2$PC2_contrib),]

library(cowplot)

plot_grid(PC1_contrib, 
          PC2_contrib)


```
  
# Discussion

# Conclusion

# Acknowledgements

<!-- The following line inserts a page break  -->

\newpage

## References 

Borel, Antony, Richard Cornette, and Michel Baylac. 2017. “Stone Tool Forms and Functions: A Morphometric Analysis of Modern Humans’ Stone Tools From Song Terus Cave (Java, Indonesia).” Archaeometry 59 (3): 455–71. https://doi.org/10.1111/arcm.12264.

Borel, Antony, Claire Gaillard, Marie-Hélène Moncel, Robert Sala, Emmanuelle Pouydebat, Truman Simanjuntak, and François Sémah. 2013. “How to Interpret Informal Flakes Assemblages? Integrating Morphological Description, Usewear and Morphometric Analysis Gave Better Understanding of the Behaviors of Anatomically Modern Human from Song Terus (Indonesia).” Journal of Anthropological Archaeology 32 (4): 630–46. https://doi.org/10.1016/j.jaa.2013.03.002.

Bradbury, Andrew P., and Philip J. Carr. "Flake Typologies and Alternative Approaches: An Experimental Assessment." Lithic Technology 20, no. 2 (1995): 100-15. Accessed June 11, 2021. http://www.jstor.org/stable/23273168.

Jung, H., & Woo, E. J. (2019). Changes in mandibular ramus shape from the Neolithic to modern periods in Korea. International Journal of Osteoarchaeology, 29(4), 634–643. https://doi.org/10.1002/oa.2759

Mijares, A. 2008. “The late pleistocene to early holocene foragers of northern Luzon.”		Bulletin of the Indo-Pacific Prehistory Association 28: 99-107.

Song, M., & Zhong, H. (2020). Efficient weighted univariate clustering maps outstanding dysregulated genomic zones in human cancers. Bioinformatics, 36(20), 5027–5036. https://doi.org/10.1093/bioinformatics/btaa613

Theska, T., Sieriebriennikov, B., Wighard, S. S., Werner, M. S., & Sommer, R. J. (2020). Geometric morphometrics of microscopic animals as exemplified by model nematodes. Nature Protocols, 15(8), 2611–2644. https://doi.org/10.1038/s41596-020-0347-z
 
Wang, H., & Song, M. (2011). Ckmeans.1d.dp: Optimal k-means Clustering in One Dimension by Dynamic Programming. The R Journal, 3(2), 29–33.


<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

<div id="refs"></div>

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
